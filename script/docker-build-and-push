#!/bin/bash

set -ev

quay_image=quay.io/travisci/travis-live
tag_name=$(echo "$TRAVIS_BRANCH" | sed -e "s/\\//-/g")

source ~/virtualenv/python2.7/bin/activate
pip install docker-squash

docker build -t "${quay_image}:${tag_name}" --build-arg SIDEKIQ_PRO_GEMSOURCE="${BUNDLE_GEMS__CONTRIBSYS__COM}" .

docker-squash -t "${quay_image}:${tag_name}" "${quay_image}:${tag_name}"

docker login -u=$QUAY_ROBOT_HANDLE -p=$QUAY_ROBOT_TOKEN quay.io;

docker images;

docker push "${quay_image}:${tag_name}";

docker tag "${quay_image}:${tag_name}" "${quay_image}:${TRAVIS_COMMIT:0:7}";
docker push "${quay_image}:${TRAVIS_COMMIT:0:7}";

if [ ${TRAVIS_BRANCH} = "master" ]; then
  docker tag "${quay_image}" "${quay_image}:latest";
  docker push "${quay_image}:latest";
fi

exit 0;
